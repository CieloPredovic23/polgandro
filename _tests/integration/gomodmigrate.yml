format_version: 8
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

workflows:
  test_gopath_disabled:
    steps:
      - script:
          inputs:
          - content: |-
              #!/usr/bin/env bash
              envman add --key GO111MODULE --value on
    after_run:
      - gopath
      - gomod

  test_gopath_enabled:
    steps:
      - script:
          inputs:
          - content: |-
              #!/usr/bin/env bash
              envman add --key GO111MODULE --value auto
    after_run:
      - gopath
      - gomod

  gopath:
    steps:
      - npm@1.1.4:
          inputs:
          - command: install

  gomod:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            envman add --key TMP_DIR --value $(mktemp -d -t gomodmigrateXXXXXX)
    - change-workdir:
        title: Switch working dir to test/_tmp dir
        run_if: "true"
        inputs:
        - path: $TMP_DIR
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            mkdir fastlane
            echo "default_platform(:ios)

            platform :ios do
              lane :test_fastlane do
              end
            end
            " > $TMP_DIR/fastlane/Fastfile
    - fastlane@3.2.0:
        inputs:
        - lane: test_fastlane
        - work_dir: $TMP_DIR
        - update_fastlane: "false"
        - connection: "off"

