format_version: 1.0.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

trigger_map:
# deprecated trigger
- pattern: deprecated_master
  is_pull_request_allowed: false
  workflow: deprecated_master
- pattern: deprecated_master*
  is_pull_request_allowed: true
  workflow: deprecated_master_trigger
# new trigger
- push_branch: feature/*
  workflow: test
- pull_request_source_branch: feature/*
  pull_request_target_branch: develop
  workflow: pr_test
- pull_request_target_branch: deploy_*
  workflow: release
- pull_request_source_branch: develop
  workflow: primary


workflows:
  pr_integration_tests:
    steps:
    - script:
        title: Ensure CURRENT_BITRISE
        inputs:
        - content: |-
            #!/bin/bash
            set -e

            if [ -z "$CURRENT_BITRISE" ] ; then
              envman add --key CURRENT_BITRISE --value "bitrise"
            fi
    - script:
        title: Run trigger integration tests
        inputs:
        - content: |-
            #!/bin/bash

            echo "deprecated trigger test"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","pattern":"deprecated_master","format":"json"}')
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"deprecated_master","workflow":"deprecated_master"}' ] ; then
              exit 1
            fi
            echo "----------"

            echo "deprecated trigger test - PR mode"
            out=$(PR="true" $CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","pattern":"deprecated_master","format":"json"}')
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"deprecated_master","workflow":"deprecated_master_trigger"}' ] ; then
              exit 1
            fi
            echo "----------"

            echo "new trigger test - code push"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","push-branch":"feature/login","format":"json"}')
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"","workflow":"test"}' ] ; then
              exit 1
            fi
            echo "----------"

            echo "new trigger test - pull request - defined source and target pattern"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","pr-source-branch":"feature/login","pr-target-branch":"develop","format":"json"}')
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"","workflow":"pr_test"}' ] ; then
              exit 1
            fi
            echo "----------"

            echo "new trigger test base64 - pull request - defined source and target pattern"
            base64_params=$(echo '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","pr-source-branch":"feature/login","pr-target-branch":"develop","format":"json"}'|openssl base64)
            out=$($CURRENT_BITRISE trigger-check --json-params-base64 "$base64_params")
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"","workflow":"pr_test"}' ] ; then
              exit 1
            fi
            echo "----------"

            echo "new trigger test - pull request - defined target pattern"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","pr-source-branch":"master","pr-target-branch":"deploy_1_0_0","format":"json"}')
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"","workflow":"release"}' ] ; then
              exit 1
            fi
            echo "----------"

            echo "new trigger test - pull request - defined source pattern"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/bitrise-trigger-integration.yml","pr-source-branch":"develop","pr-target-branch":"master","format":"json"}')
            status=$?
            echo "status: $status"
            echo "out: $out"
            if [ $status -ne 0 ] ; then
              exit 1
            fi
            if [ "$out" != '{"pattern":"","workflow":"primary"}' ] ; then
              exit 1
            fi
            echo "----------"

  test:
  pr_test:
  release:
  primary:
  deprecated_master:
  deprecated_master_trigger: